# Launch Guide — Print CRM

Этот гайд описывает, как развернуть и запустить CRM/ERP-систему для типографии  
(Backend: Node.js + Express + SQLite + Knex, Frontend: Vue 3 + Vite + Pinia + Vue Router).

---

## 1. Prerequisites

Перед началом убедитесь, что у вас установлено:

- **Node.js и npm**
  - Рекомендуется LTS-версия Node.js.
  - Проверка версий: `node -v`, `npm -v`
  - Установка: https://nodejs.org/

- **Git** (если проект хранится в репозитории)
  - Проверка: `git --version`

- **SQLite3** (опционально — для работы с БД из консоли)
  - Проверка: `sqlite3 --version`

---

## 2. Структура проекта

Предполагаемая структура папок:

pdcrm/  
├── backend/  
│   ├── package.json  
│   ├── knexfile.js          — конфиг для Knex (SQLite)  
│   ├── .env.example  
│   └── src/  
│       ├── server.js        — точка входа backend  
│       ├── app.js           — конфигурация Express  
│       ├── config/          — чтение .env, глобальные настройки  
│       ├── db/  
│       │   ├── connection.js  
│       │   ├── migrations/  — миграции (users, orders, products и т.д.)  
│       │   └── seeds/       — стартовые данные (11 пользователей и прочее)  
│       ├── models/          — низкоуровневый доступ к БД через Knex  
│       ├── services/        — бизнес-логика  
│       ├── controllers/     — обработка req/res  
│       ├── routes/          — REST-маршруты /api/...  
│       ├── middleware/      — auth, permissions, error handler  
│       └── utils/           — вспомогательные функции  
├── frontend/  
│   ├── package.json  
│   ├── vite.config.js  
│   ├── index.html  
│   └── src/  
│       ├── main.js          — точка входа фронта  
│       ├── App.vue  
│       ├── router/          — маршрутизация (login, dashboard, orders и т.д.)  
│       ├── store/           — Pinia (authStore, uiStore, ordersStore...)  
│       ├── api/             — Axios-клиенты к backend API  
│       ├── views/           — страницы: DashboardView, OrdersView, CashView...  
│       ├── components/      — общие компоненты, layout, карточки  
│       └── assets/          — стили, шрифты, картинки  
└── docs/  
    ├── architecture.md      — архитектура приложения  
    └── launch.md            — данный файл  

---

## 3. Первичная настройка проекта

### 3.1. Клонирование репозитория

Если проект в GitHub:

- `git clone <URL-ВАШЕГО-РЕПОЗИТОРИЯ> pdcrm`  
- `cd pdcrm`

Либо просто положите все файлы проекта в директорию `pdcrm`.

---

### 3.2. Настройка backend

1. Перейти в папку backend и установить зависимости:  
   `cd backend`  
   `npm install`

2. Создать файл окружения `.env` (из `.env.example`):

   - Linux/macOS: `cp .env.example .env`  
   - Windows: скопировать `.env.example` вручную и переименовать в `.env`

3. Пример содержимого `.env`:

   NODE_ENV=development  
   PORT=3000  
   DB_PATH=./data/crm.sqlite  
   JWT_SECRET=super-secret-key  
   CORS_ORIGIN=http://localhost:5173  

   Важно:  
   - `PORT` — порт backend (по умолчанию 3000)  
   - `DB_PATH` — путь к файлу SQLite (создастся при миграциях)  
   - `CORS_ORIGIN` — адрес фронта в dev-режиме (обычно `http://localhost:5173`)

4. Выполнить миграции и сиды базы данных (через Knex, из папки backend):  
   `npx knex migrate:latest`  
   `npx knex seed:run`  

   Миграции создадут таблицы (users, orders, products, warehouse и т.д.),  
   сиды заполнят стартовыми данными (включая 11 сотрудников).

---

### 3.3. Настройка frontend

1. Перейти в папку `frontend` и установить зависимости:  
   `cd ../frontend`  
   `npm install`

2. Настроить базовый URL API (пример: `src/api/http.js`):

   - создать/изменить общий Axios-инстанс:
     - `baseURL: 'http://localhost:3000/api'`
     - `withCredentials: false` (по желанию)

3. Вернуться в корень проекта (опционально):  
   `cd ..`

---

## 4. Запуск в режиме разработки

Рекомендуется использовать два терминала:  
один для backend, второй для frontend.

### 4.1. Запуск backend (API-сервер)

В первом терминале:

- `cd path/to/pdcrm/backend`  
- `npm run dev`

`npm run dev` обычно запускает `nodemon src/server.js`  
и поднимает Express-сервер на порту из `.env` (по умолчанию `http://localhost:3000`).

Ожидаемое лог-сообщение:

Print CRM backend server running at http://localhost:3000

### 4.2. Запуск frontend (Vue-приложение)

Во втором терминале:

- `cd path/to/pdcrm/frontend`  
- `npm run dev`

По умолчанию Vite запустит dev-сервер на `http://localhost:5173`.

Откройте этот адрес в браузере. Ожидается:

1. Экран авторизации по коду доступа.  
2. После успешного входа — основное приложение:
   - слева — меню (Дэшборд, Заказы, Касса, Склад, Персонал, Аналитика, Справочники, Настройки, Разрешения);  
   - сверху — хэдер с приветствием, именем, ролью и серыми кругами:
     - круг темы (переключатель светлая/тёмная),
     - круг уведомлений (колокольчик).

---

## 5. Сборка и запуск в продакшене

### 5.1. Сборка frontend

Из папки `frontend`:

- `npm run build`

Vite соберёт статические файлы в `frontend/dist/`:

frontend/dist/  
├── index.html  
└── assets/ …

Дальнейшие варианты:

1. Отдавать `dist/` через отдельный веб-сервер (Nginx, Apache), или  
2. Скопировать содержимое `dist/` в папку внутри backend (например, `backend/public/`) и раздавать через Express.

### 5.2. Настройка backend для раздачи фронта (опционально)

1. Скопировать содержимое `frontend/dist` в `backend/public` (создайте папку, если её нет):  
   - пример для Linux/macOS: `cp -r ../frontend/dist/* ./public/`

2. В `backend/src/app.js` после API-маршрутов добавить:

   - подключение `express.static` к `public`  
   - маршрут `app.get('*', ...)`, который всегда отдаёт `public/index.html`  
   (нужен для корректной работы Vue Router в режиме history)

3. В `.env` для продакшена:

   NODE_ENV=production  
   PORT=3000  
   DB_PATH=./data/crm.sqlite  
   JWT_SECRET=super-secret-key  
   CORS_ORIGIN=http://localhost:3000  

### 5.3. Запуск backend в продакшене

Из папки `backend`:

- `npm install --production`  
- `npm run start`  (например, `node src/server.js`)

Для постоянной работы на сервере:

- установить pm2: `npm install -g pm2`  
- запустить: `pm2 start src/server.js --name pdcrm`  
- проверка статуса: `pm2 status`

---

## 6. Авторизация, роли и интерфейс

### 6.1. Авторизация по коду доступа

- На экране логина вводится только код доступа.  
- Backend ищет пользователя по `access_code_hash` в таблице `users`.  
- При успешной проверке возвращается JWT и данные пользователя.  
- После входа:
  - в шапке выводится приветствие по времени суток  
    (Доброе утро/день/вечер, Имя!),  
  - показывается мотивационная фраза,  
  - отображаются имя и роль (например, “Никита — Производство”).

### 6.2. Роли пользователей

Стартовые пользователи (по сид-данным):

- Дизайнеры: Александр, Анастасия, Валентина, Юлия, Ольга (`role = 'designer'`)  
- Производство: Никита, Виктор, Павел, Екатерина (`role = 'production'`)  
- Директор: Евгений (`role = 'director'`)  
- Админ: Андрей (`role = 'admin'`)

Пример демо-кодов доступа (фактические смотреть в seeds):

- Евгений (директор): 1001  
- Андрей (админ): 1002  
- Александр (дизайнер): 2001  
- Анастасия (дизайнер): 2002  
- Валентина (дизайнер): 2003  
- Юлия (дизайнер): 2004  
- Ольга (дизайнер): 2005  
- Никита (производство): 3001  
- Виктор (производство): 3002  
- Павел (производство): 3003  
- Екатерина (производство): 3004  

Коды задаются в seed-данных (в папке `backend/src/db/seeds`) и в будущем могут изменяться через интерфейс администратора в разделе:

Справочники / Настройки → Пользователи / Права доступа

### 6.3. Хэдер: тема и уведомления

После логина в хэдере справа:

- Серый круг №1 — переключатель светлая/тёмная тема:
  - меняет тему интерфейса;
  - выбранная тема сохраняется (например, в localStorage).

- Серый круг №2 — иконка уведомлений:
  - при наличии непрочитанных уведомлений показывает маленький бейдж с числом;
  - по клику открывает список уведомлений
    (новые заказы в производстве, изменение статусов, низкие остатки на складе и т.п.).

- Серый круг №3 — резерв под быстрые настройки или системный статус (можно задействовать позже).

---

## 7. Частые проблемы и их решения

### 7.1. `node` или `npm` не найдены

- Убедитесь, что Node.js установлен и прописан в PATH.  
- После установки Node.js перезапустите терминал/PowerShell.

### 7.2. Ошибки при `npm install`

- Очистить кэш npm: `npm cache clean --force`  
- Удалить `node_modules` и `package-lock.json`, затем установить зависимости заново:  
  `rm -rf node_modules package-lock.json`  
  `npm install`

### 7.3. Ошибки миграций / проблемный файл БД

- Проверить `.env` (особенно `DB_PATH`).  
- Запустить из `backend`:  
  `npx knex migrate:latest`  
  `npx knex seed:run`  
- Если структура сильно менялась, можно удалить файл БД (например, `data/crm.sqlite`) и повторно выполнить миграции и сиды.

### 7.4. Frontend не видит API (CORS / 404)

- Проверить, что backend запущен и слушает `PORT`, указанный в `.env`.  
- Убедиться, что `CORS_ORIGIN` совпадает с адресом фронта (например, `http://localhost:5173`).  
- Проверить базовый URL в Axios (например, `http://localhost:3000/api`).  
- Убедиться, что нужные маршруты определены в `backend/src/routes`.

### 7.5. Пустая страница / ошибки в консоли

- Открыть DevTools (F12) → вкладка Console.  
- Проверить ошибки JavaScript и ошибки сетевых запросов (Network).  
- Убедиться, что `npm run dev` для backend и frontend запущены без ошибок.  
- Если используется раздача фронта через Express, проверить корректность маршрута `app.get('*', ...)` и пути к `index.html`.
