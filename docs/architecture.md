# Application Architecture

---

## 1. Core Architecture

- **Тип приложения:** Внутренняя CRM/ERP-система для типографии.
- **Слои:**
  - **Backend (API-сервер)** — Node.js + Express + SQLite (через Knex).
  - **Frontend (SPA-клиент)** — Vue 3 + Vite + Vue Router + Pinia.
- **Обмен данными:** REST API по HTTP  
  `Frontend → /api/... → Backend → SQLite`.

- **Основные доменные модули (меню):**
  1. Дэшборд
  2. Заказы (с мощным калькулятором)
  3. Финансы (Касса и финансовые отчёты)
  4. Склад и Закупка
  5. Персонал
  6. Аналитика
  7. Справочники и Настройки
  8. (Опционально) Архив документов

---

## 2. Технологический стек

### Backend

- Node.js, Express
- SQLite3
- Knex (подключение, миграции, запросы)
- JWT или сессионные токены для авторизации по кодам доступа
- express-validator (валидация входящих данных)
- dotenv (конфиги), morgan (логи), cors (CORS)

### Frontend

- Vue 3 (Composition API)
- Vite (сборка + dev)
- Vue Router (маршрутизация)
- Pinia (глобальное состояние)
- Axios (HTTP-запросы)
- Чистый CSS / UI-библиотека (по желанию)

---

## 3. Backend Architecture

### 3.1. Слои и структура

- **Routes (`routes/`)**
  - REST-эндпоинты по модулям:
    - `/api/auth` — авторизация по коду
    - `/api/orders` — заказы, позиции, статусы
    - `/api/products` — товары + ценовые уровни/скидки за тираж
    - `/api/clients` — клиенты и организации
    - `/api/warehouse` — склад, остатки, движения
    - `/api/purchase` — закупки и заявки
    - `/api/finance` — касса, платежи, смены
    - `/api/staff` — персонал, графики, учёт времени
    - `/api/analytics` — аналитика
    - `/api/settings` — справочники, права, пользователи
    - `/api/notifications` — уведомления

- **Controllers (`controllers/`)**
  - Обработка `req/res`, валидация, вызов сервисов, возврат JSON.
  - Примеры:
    - `auth.controller` — логин по кодам, выдача токена.
    - `orders.controller` — CRUD заказов, статусы, работа с калькулятором.
    - `products.controller` — выдача продукции и ценовых уровней.
    - `notifications.controller` — список/прочтение уведомлений.

- **Services (`services/`)**
  - Бизнес-логика:
    - `orders.service`
      - калькуляция позиций (тиражи, скидки за тираж, ручные скидки),
      - итоговые суммы по заказу,
      - статусные переходы (в т.ч. “Отправить в производство”).
    - `warehouse.service`
      - списание/приход материалов,
      - контроль минимальных остатков,
      - генерация заявок в закупку.
    - `purchase.service`
      - логика закупок и статусов заявок.
    - `finance.service`
      - касса, платежи, смены, фин. отчёты.
    - `staff.service`
      - графики, приход/уход, статусы “на рабочем месте”.
    - `analytics.service`
      - агрегированные отчёты по продажам, персоналу, складу.
    - `permissions.service`
      - проверка индивидуальных прав (ограничения для конкретных пользователей).
    - `notifications.service`
      - создание уведомлений при событиях (новый заказ, изменение статуса и т.п.).

- **Models (`models/`)**
  - Низкоуровневый CRUD через Knex.
  - Ключевые таблицы:
    - `users`, `user_permissions`
    - `clients`, `organizations`
    - `orders`, `order_items`
    - `products`, `product_categories`
    - `product_price_tiers` (скидки/цены за тираж)
    - `materials`, `warehouse_items`, `warehouse_movements`
    - `purchase_requests`, `purchase_orders`, `purchase_order_items`
    - `payments`, `cash_shifts`
    - `staff`, `staff_schedule`, `staff_attendance`
    - `notifications`

- **DB слой (`db/`)**
  - `knexfile.js` — конфиг подключения SQLite.
  - `connection.js` — инстанс Knex.
  - `migrations/` — определения таблиц и их изменений.
  - `seeds/` — стартовые данные:
    - 11 пользователей,
    - базовые товары, категории, материалы,
    - статусы заказов и базовые настройки.

- **Инфраструктура (`config/`, `middleware/`, `utils/`)**
  - `config/` — .env, пути, порты, режимы.
  - `middleware/`:
    - `auth` — проверка токена, установка `req.user`.
    - `permissions` — проверка права `can(user, 'orders.delete')`.
    - `errorHandler`, `notFound`, базовый `cors`, `logging`.
  - `utils/`:
    - расчёт скидок по тиражу,
    - форматы телефонов,
    - мотивационные фразы (если делаются на бэке),
    - пагинация, форматирование дат/денег.

---

## 4. Frontend Architecture

### 4.1. Каркас

- `App.vue`:
  - **Хэдер**:
    - приветствие: “Доброе утро/день/вечер, {Имя}!”
    - мотивационная фраза,
    - имя пользователя,
    - иконка уведомлений (количество непрочитанных),
    - глобальный поиск.
  - **Сайдбар/меню**:
    - Дэшборд, Заказы, Финансы, Склад и Закупка, Персонал, Аналитика, Справочники, (Документы).
  - **Основной контент** (router-view).

- `main.js`:
  - инициализация Vue, Router, Pinia,
  - глобальные компоненты, стили.

### 4.2. Маршруты (`router/`)

- Основные маршруты:
  - `/login` — авторизация по коду.
  - `/dashboard` — дэшборд.
  - `/orders` — список заказов.
  - `/orders/:id` — карточка заказа (с калькулятором).
  - `/finance` — касса/финансы.
  - `/warehouse` — склад + закупка.
  - `/staff` — персонал.
  - `/analytics` — отчёты и аналитика.
  - `/settings` — справочники и настройки.
- Guard’ы:
  - проверка токена,
  - редирект на `/login` при отсутствии авторизации.

### 4.3. Хранилище (Pinia, `store/`)

- `authStore` — токен, текущий пользователь (`id`, `name`, `role`), логин/логаут.
- `uiStore` — выбранные виджеты дэшборда, состояние интерфейса.
- `ordersStore` — список заказов, текущий заказ, фильтры, режимы (таблица/канбан).
- `productsStore` — кэш списка товаров и ценовых уровней.
- `warehouseStore` — остатки материалов, заявки на закупку.
- `notificationsStore` — непрочитанные/прочитанные уведомления.
- при необходимости — дополнительные сторы (finance, staff, analytics).

### 4.4. API-слой (`api/`)

- `auth.api` — вход по коду, обновление токена.
- `orders.api` — CRUD заказов, изменение статусов, загрузка позиций.
- `products.api` — товары, категории, ценовые уровни (скидки за тираж).
- `clients.api` — клиенты, организации.
- `warehouse.api`, `purchase.api` — склад, закупка.
- `finance.api` — платежи, смены, кассовые отчеты.
- `staff.api` — персонал, графики, присутствие.
- `analytics.api` — статистика и отчёты.
- `settings.api` — справочники, права, пользователи.
- `notifications.api` — получение/прочтение уведомлений.

### 4.5. Компоненты

- **UI-общие:**
  - `AppHeader`, `AppSidebar`, `AppModal`, `AppTable`, `AppToast`, `AppButton`, `AppCard`.
  - `GlobalSearch` — поиск по клиентам/заказам и т.п.
- **Заказы:**
  - `OrderList` — список/таблица.
  - `OrderKanbanBoard` — канбан с drag’n’drop.
  - `OrderCalculator` — калькулятор (позиции, скидки, итоги).
  - `OrderItemsTable` — таблица позиций.
- **Склад и закупка:**
  - `MaterialList`, `LowStockList`, `PurchaseRequestList`.
- **Персонал:**
  - `StaffList`, `StaffStatusBoard`.
- **Аналитика:**
  - графики выручки, производительности, топов.
- **Настройки:**
  - `UserPermissionsTable`, формы справочников (продукция, материалы, статусы).

---

## 5. Authentication & Permissions

### 5.1. Пользователи и коды доступа

- Всего **11 человек**:
  - Дизайнеры: Александр, Анастасия, Валентина, Юлия, Ольга (`role: 'designer'`).
  - Производство: Никита, Виктор, Павел, Екатерина (`role: 'production'`).
  - Директор: Евгений (`role: 'director'`).
  - Администратор: Андрей (`role: 'admin'`).

- **Авторизация:**
  - Экран логина: одно поле “Код доступа”.
  - Backend:
    - ищет пользователя по хешу кода (`access_code_hash` в `users`),
    - при успехе — возвращает токен + профиль (`id`, `name`, `role`).
  - Админ/директор задают/меняют коды доступа в настройках.

### 5.2. Права и ограничения

- Базовая модель: **“все могут всё”**, пока директор не ограничил.
- Таблица `user_permissions` хранит **индивидуальные запреты**:
  - пример ключей:
    - `orders.delete`, `orders.cancel`, `orders.update_paid`
    - `finance.export`, `payments.refund`
    - `warehouse.update_stock`
    - `settings.edit_users`, `settings.edit_permissions`
- Интерфейс прав:
  - раздел “Справочники и Настройки → Права доступа”.
  - директор/админ видят список пользователей с чекбоксами “что запрещено”.
- Backend:
  - middleware проверяет `can(user, permissionKey)` перед опасными действиями.
- Frontend:
  - скрывает кнопки/экшены, если нет прав, но окончательное решение — на backend.

---

## 6. Business Modules (по категориям меню)

### 6.1. Дэшборд

- Модульная главная страница:
  - виджеты:
    - Мои активные заказы,
    - Неоплаченные заказы,
    - Ближайшие дедлайны,
    - “Мало материала” (низкие остатки),
    - Выручка за день/месяц/год,
    - Личная статистика (“сколько заказов сделал”, “на какую сумму”).
- Профили дэшборда по ролям (дизайнер, производство, директор и т.д.).
- Привязка к уведомлениям (например, виджет “Новые заказы в производстве”).

### 6.2. Заказы + Калькулятор

- Список заказов:
  - фильтры: мои / все, по статусу, датам, клиенту/организации.
  - режимы: таблица ↔ канбан (статусы колонками, drag’n’drop).
- Карточка заказа:
  - клиент/организация,
  - дедлайны (дата + время),
  - статус,
  - позиции (калькулятор),
  - комментарии и файлы,
  - история изменений.
- **Калькулятор:**
  - неограниченное число позиций.
  - каждая позиция:
    - выбор товара из базы `products`,
    - подтягивание единицы измерения, базовой цены,
    - ввод тиража/количества,
    - автоприменение скидок за тираж из `product_price_tiers`,
    - вычисление цены за единицу и суммы,
    - ручная корректировка цены/скидки/итога, если нужно,
    - комментарий по позиции.
  - итоги:
    - сумма по позициям,
    - скидка на весь заказ (в % или суммой),
    - предоплата/остаток к оплате.
- Связка “Дизайнер → Производство”:
  - дизайнер нажимает “Отправить в производство”:
    - статус → `in_production`,
    - создаются уведомления для роли `production`,
    - заказы появляются в их списке/канбане.

### 6.3. Финансы (Касса)

- Касса:
  - список неоплаченных/частично оплаченных заказов.
  - быстрый выбор способа оплаты (нал, карта, безнал).
  - проведение оплат, предоплат, доплат.
- Платежи и счета:
  - журнал всех оплат.
  - выставленные счета, повторная печать/выгрузка.
- Кассовые смены:
  - открытие/закрытие смен,
  - итоги за смену.
- Финансовые отчеты:
  - выручка по периодам,
  - экспорт в Excel/CSV.

### 6.4. Склад и Закупка

- Склад:
  - материалы, единицы измерения, текущие остатки.
  - минимальный остаток по каждому материалу.
  - история движений (приход/расход).
- Закупка:
  - авто-заявки при падении ниже минимума.
  - ручные заявки.
  - статусы: `new` → `in_progress` → `ordered` → `received`.
- В будущем:
  - связка с заказами: “рецепты” материалов на единицу товара,
  - автоматическое списание материалов при проведении заказа.

### 6.5. Персонал

- Список сотрудников:
  - ФИО, роль, отдел, активность.
- График работы:
  - смены, отпуска, больничные.
- Учёт присутствия:
  - приход/уход, статусы “на месте / отсутствует”.
- Базовая аналитика:
  - количество выполненных заказов,
  - просрочки и т.п.

### 6.6. Аналитика

- Продажи:
  - выручка по дням/месяцам/годам,
  - сравнение периодов,
  - топ-клиенты, топ-продукты.
- Производство:
  - среднее время исполнения,
  - узкие места.
- Персонал:
  - производительность по людям/отделам.
- Отчеты:
  - формирование и скачивание сводных отчётов.

### 6.7. Справочники и Настройки

- Справочники:
  - товары, категории товаров,
  - материалы,
  - статусы заказов,
  - способы оплаты,
  - отделы, должности,
  - шаблоны документов.
- Настройки:
  - маска телефона (`+7` + 10 цифр),
  - таблицы скидок за тиражность,
  - права доступа по пользователям,
  - пресеты дэшборда по ролям,
  - бизнес-настройки (налоги, валюта и т.п.).

### 6.8. Уведомления и Архив

- Уведомления:
  - новые заказы для производства,
  - изменение статусов,
  - низкие остатки,
  - важные события.
- Архив документов (опционально):
  - поиск по датам, клиентам, типу документа,
  - переход из документа к заказу и обратно.

---

## 7. Key Data Structures (коротко)

- `users`: сотрудники + роль + код доступа.
- `user_permissions`: индивидуальные запреты.
- `products`: товары с базовой ценой.
- `product_price_tiers`: диапазоны тиражей и цены/скидки.
- `orders`: общая информация по заказу.
- `order_items`: позиции заказа (товар, тираж, цены, скидки, итог).
- `warehouse_*`: материалы, остатки, движения.
- `purchase_*`: заявки и заказы на закупку.
- `payments`, `cash_shifts`: финансы и касса.
- `staff_*`: данные по персоналу.
- `notifications`: уведомления по событиям.

---

## 8. Основные потоки

1. **Авторизация по коду**  
   Пользователь вводит код → backend выдает токен и профиль → фронт строит интерфейс, хэдер с именем и приветствием.

2. **Создание заказа с калькулятором**
   - менеджер/дизайнер открывает форму;
   - добавляет позиции, выбирая товары из базы;
   - вводит тиражи → автоматически применяются скидки за тираж;
   - при необходимости корректирует цену/скидки руками;
   - сохраняет заказ (статус `draft` или `ready_for_prod`).

3. **Отправка заказа в производство**
   - дизайнер нажимает “Отправить в производство”;
   - заказ меняет статус на `in_production`;
   - создаются уведомления для всех пользователей `production`;
   - в их списке/канбане появляется новый заказ.

4. **Оплата и касса**
   - в разделе Финансы/Касса видны неоплаченные заказы;
   - выбрали способ оплаты → записали платеж → обновили статус оплаты.

5. **Склад и закупка**
   - (позже) при проведении заказов списываются материалы;
   - при падении ниже минимального остатков создаются заявки на закупку;
   - они видны в разделе Склад/Закупка.

6. **Аналитика и отчеты**
   - директор и сотрудники смотрят свои показатели,
   - дэшборд + отдельный раздел Аналитика дают картину по продажам, персоналу и складу.

