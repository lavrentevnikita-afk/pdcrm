# Application Architecture

---

## 1. Core Architecture

- **Тип приложения:** внутренняя CRM/ERP-система для типографии.
- **Слои:**
  - **Backend (API-сервер)** — Node.js + Express + SQLite (через Knex).
  - **Frontend (SPA-клиент)** — Vue 3 + Vite + Vue Router + Pinia.
- **Обмен данными:** REST API по HTTP  
  `Frontend → /api/... → Backend → SQLite`.

- **Основные разделы (левое меню, как на макетах):**
  - **Основные**
    1. Дэшборд
    2. Заказы (список + создание через правый drawer + калькулятор)
    3. Касса
    4. Склад
  - **Управление**
    5. Персонал
    6. Аналитика
    7. Справочники
  - **Другое**
    8. Настройки
    9. Разрешения

*(Архив документов при необходимости можно добавить позже в Аналитику/Документы.)*

---

## 2. Технологический стек

### Backend

- Node.js, Express
- SQLite3
- Knex (подключение, миграции, запросы)
- JWT для авторизации по кодам доступа
- express-validator (валидация входящих данных)
- dotenv (конфиги)
- morgan (HTTP-логи)
- cors (CORS)

### Frontend

- Vue 3 (Composition API)
- Vite (сборка + dev)
- Vue Router (маршрутизация)
- Pinia (глобальное состояние)
- Axios (HTTP-запросы)
- Чистый CSS / Tailwind (или лёгкая UI-библиотека)
- CSS-переменные для **двух тем** (light / dark) и общей цветовой палитры

### Цветовая палитра (Design Tokens)

- **Нейтральные серые (верхний ряд на референсе):**
  - светло-серый — фон карточек, бордеры, muted-текст,
  - средний/тёмный серый — сайдбар, панели, вспомогательные элементы,
  - почти чёрный — фоны тёмной темы, контрастные акценты.

- **Базовые холодные (средний ряд):**
  - светлый серо-голубой — hover, фон активных блоков,
  - яркий голубой — ссылки, вторичные кнопки, акценты,
  - насыщенный синий — основной brand / primary (крупные карточки, главные кнопки).

- **Сигнальные (нижний ряд):**
  - зелёный — успех (оплачено, “в норме”),
  - кораллово-красный — ошибки, критика, просроченные дедлайны.

Все цвета оформляются как CSS-переменные (`--color-primary`, `--color-bg`, `--color-success` и т.п.) c отдельными наборами значений для светлой и тёмной темы.

---

## 3. Backend Architecture

### 3.1. Слои и структура

- **Routes (`src/routes/`)**
  - REST-эндпоинты по модулям:
    - `/api/auth` — авторизация по коду.
    - `/api/users` — пользователи (для админа/директора).
    - `/api/orders` — заказы, статусы.
    - `/api/order-items` — позиции заказов (если нужно выделить отдельно).
    - `/api/products` — продукция + ценовые уровни/скидки за тираж.
    - `/api/clients` — клиенты и организации.
    - `/api/cash` — выборка неоплаченных заказов, касса.
    - `/api/payments` — платежи.
    - `/api/warehouse` — склад, остатки, движения.
    - `/api/purchase` — закупки и заявки.
    - `/api/staff` — персонал, статусы.
    - `/api/analytics` — агрегированная аналитика.
    - `/api/settings` — справочники, общие настройки.
    - `/api/permissions` — права доступа.
    - `/api/notifications` — уведомления.

- **Controllers (`src/controllers/`)**
  - Обрабатывают `req/res`, валидируют данные, вызывают сервисы, возвращают JSON.
  - Примеры:
    - `auth.controller` — логин по коду, выдача/обновление токена.
    - `orders.controller` — CRUD заказов, смена статусов, работа с калькулятором.
    - `products.controller` — выдача продукции и ценовых уровней.
    - `cash.controller` — список неоплаченных заказов, операции кассы.
    - `warehouse.controller` — остатки, движения, low-stock.
    - `permissions.controller` — чтение/запись прав.
    - `notifications.controller` — список/прочтение уведомлений.

- **Services (`src/services/`)**
  - Бизнес-логика:
    - `orders.service`  
      - создание/редактирование заказа,  
      - калькуляция позиций (тиражи, скидки за тираж, ручные скидки),  
      - пересчёт итоговых сумм,  
      - статусные переходы (в т.ч. “Отправить в производство”).
    - `pricing.service`  
      - расчёт стоимости по `product_price_tiers` и общим скидкам.
    - `warehouse.service`  
      - списание/приход материалов,  
      - контроль минимальных остатков,  
      - генерация заявок в закупку.
    - `purchase.service`  
      - обработка заявок на закупку и их статусов.
    - `finance.service`  
      - касса, платежи, смены, фин.результаты.
    - `staff.service`  
      - данные по сотрудникам, статусы “на рабочем месте”.
    - `analytics.service`  
      - агрегаты по продажам, складу, персоналу.
    - `permissions.service`  
      - проверка индивидуальных прав (`can(user, permissionKey)`).
    - `notifications.service`  
      - создание уведомлений (новый заказ, изменение статуса, low-stock и т.п.).

- **Models (`src/models/`)**
  - Низкоуровневый CRUD через Knex.
  - Основные таблицы:
    - `users`, `user_permissions`
    - `clients`, `organizations`
    - `orders`, `order_items`
    - `products`, `product_categories`, `product_price_tiers`
    - `materials`, `warehouse_items`, `warehouse_movements`
    - `purchase_requests`, `purchase_orders`, `purchase_order_items`
    - `payments`, `cash_shifts`
    - `staff`, `staff_schedule`, `staff_attendance` (по мере необходимости)
    - `notifications`

- **DB слой (`src/db/`)**
  - `knexfile.js` — конфиг SQLite.
  - `connection.js` — инициализация Knex.
  - `migrations/` — создание/изменение таблиц.
  - `seeds/` — стартовые данные:
    - 11 пользователей (с ролями и хешами кодов);
    - базовые товары, категории, материалы;
    - статусы заказов, методы оплаты, минимальные настройки.

- **Инфраструктура (`src/config/`, `src/middleware/`, `src/utils/`)**
  - `config/` — чтение `.env`, константы.
  - `middleware/`:
    - `authMiddleware` — проверка JWT, установка `req.user`.
    - `permissionsMiddleware` — проверка ключей прав.
    - `errorHandler`, `notFound`.
    - `requestLogger` (morgan), базовый `cors`.
  - `utils/`:
    - расчёт скидок по тиражу и на заказ,
    - форматирование телефонов, дат, денег,
    - генератор мотивационных фраз (если делается на бэке),
    - утилиты пагинации, сортировки.

---

## 4. Frontend Architecture

### 4.1. Каркас

- `main.js`:
  - инициализация Vue, Router, Pinia;
  - подключение глобальных стилей и темы;
  - установка базовых Axios-настроек.

- `App.vue`:
  - оборачивает всё в `MainLayout` (кроме `/login`).

- `MainLayout.vue`:
  - **Сайдбар** (слева):
    - логотип/название “Печатный двор — внутренняя CRM система”;
    - поиск по меню;
    - разделы:
      - Основные: Дэшборд, Заказы, Касса, Склад;
      - Управление: Персонал, Аналитика, Справочники;
      - Другое: Настройки, Разрешения;
    - внизу — версия (`PDCRM v0.1 phaseX`) и кнопка “Выход”.
  - **Хэдер** (сверху):
    - приветствие: “Доброе утро/день/вечер, {Имя}!”;
    - подзаголовок с названием текущего раздела;
    - мотивационная фраза;
    - бейдж роли (“Производство”, “Дизайн”, “Директор”, “Админ”);
    - **серые круги**:
      - круг 1 — переключатель светлая/тёмная тема;
      - круг 2 — иконка уведомлений (с бейджем количества);
      - круг 3 — резерв под будущий статус/настройки.
  - **Контент**:
    - `<router-view />` с конкретной страницей.

### 4.2. Маршруты (`src/router/`)

- Основные маршруты:
  - `/login` — авторизация по коду доступа.
  - `/dashboard` — дэшборд.
  - `/orders` — список заказов.
  - `/orders/:id` — карточка/редактор заказа (с калькулятором).
  - `/cash` — раздел “Касса”.
  - `/warehouse` — “Склад” (остатки + закупка).
  - `/staff` — “Персонал”.
  - `/analytics` — “Аналитика”.
  - `/directories` — “Справочники”.
  - `/settings` — “Настройки”.
  - `/permissions` — “Разрешения”.
- Guard’ы:
  - проверка токена перед приватными маршрутами;
  - `authStore.fetchMe()` при наличии токена;
  - редирект на `/login` при отсутствии авторизации.

### 4.3. Хранилище (Pinia, `src/store/`)

- `authStore`  
  токен, профиль пользователя (`id`, `name`, `role`), методы `login`, `logout`, `fetchMe`.
- `uiStore`  
  текущая тема (light/dark), состояние drawer’ов/модалок, конфиг дэшборда.
- `ordersStore`  
  список заказов, активный заказ, фильтры, статусы.
- `productsStore`  
  продукция, категории, ценовые уровни.
- `warehouseStore`  
  материалы, остатки, low-stock, заявки на закупку.
- `cashStore`  
  неоплаченные заказы, текущая смена, платежи (кэшируются для UI).
- `staffStore`, `analyticsStore`, `notificationsStore` — по мере реализации.

### 4.4. API-слой (`src/api/`)

- `auth.api` — login, logout, `/me`.
- `dashboard.api` — данные для дэшборда (суммы, активные/завершённые, горящие, график).
- `orders.api` — CRUD заказов, статусы, загрузка позиций.
- `products.api` — список продукции, категории, ценовые уровни.
- `clients.api` — клиенты, организации.
- `cash.api` — список заказов для кассы, смены.
- `payments.api` — проведение оплат.
- `warehouse.api` — остатки и движения.
- `purchase.api` — заявки на закупку.
- `staff.api` — персонал, статусы.
- `analytics.api` — отчёты и графики.
- `settings.api` — справочники, общие настройки.
- `permissions.api` — права доступа.
- `notifications.api` — загрузка/прочтение уведомлений.

### 4.5. Компоненты

- **Общие:**
  - `AppHeader`, `AppSidebar`, `AppCard`, `AppButton`, `AppInput`, `AppSelect`.
  - `AppTable` — таблицы с пагинацией/сортировкой.
  - `AppModal`, `AppDrawer` — модалки и правые панели.
  - `AppToast` — тосты (ошибки/успех/инфо).

- **Дэшборд:**
  - `DashboardTotalCard` — “Сумма заказов”.
  - `DashboardStatCard` — “Активные / Завершённые”.
  - `DashboardWorkloadChart` — график загруженности.
  - `DashboardHotOrders` — “Горящие заказы”.

- **Заказы:**
  - `OrdersViewLayout` — фильтры + список + правая сводка.
  - `OrderCard` — карточка заказа (как на макете).
  - `OrderSummarySidebar` — “Активные / Готовые / Завершенные”.
  - `OrderCreateDrawer` — правый drawer “Создание заказа”.
  - `OrderItemRow` — строка калькулятора.
  - `OrderItemsTable` — таблица позиций.

- **Касса:**
  - `CashFilterBar`, `CashOrdersTable`, `PaymentModal`.

- **Склад и закупка:**
  - `WarehouseTable`, `MaterialFormModal`, `LowStockBadge`, `PurchaseRequestList`.

- **Персонал:**
  - `StaffTable`, `StaffCard`.

- **Аналитика:**
  - `RevenueChart`, `TopProductsTable`, `TopClientsTable`.

- **Справочники/права:**
  - `DirectoryEditor`, `UserPermissionsTable`.

---

## 5. Authentication & Permissions

### 5.1. Пользователи и коды доступа

- Всего **11 человек**:
  - Дизайнеры: Александр, Анастасия, Валентина, Юлия, Ольга — `role: 'designer'`.
  - Производство: Никита, Виктор, Павел, Екатерина — `role: 'production'`.
  - Директор: Евгений — `role: 'director'`.
  - Администратор: Андрей — `role: 'admin'`.

- **Авторизация:**
  - Экран логина с одним полем “Код доступа”.
  - Backend:
    - ищет пользователя по `access_code_hash` в `users`;
    - при успехе — возвращает JWT + профиль (`id`, `name`, `role`).
  - Коды доступа задаются/меняются директором/админом в разделе “Справочники/Настройки”.

### 5.2. Права и ограничения

- Базовая модель: **по умолчанию все могут всё**, пока директор/админ не наложил запреты.
- Таблица `user_permissions` хранит **индивидуальные запреты**:
  - примеры ключей:
    - `orders.delete`, `orders.cancel`, `orders.update_paid`;
    - `finance.export`, `payments.refund`;
    - `warehouse.update_stock`;
    - `settings.edit_users`, `settings.edit_permissions`.
- UI:
  - раздел “Разрешения” — список пользователей + матрица чекбоксов по действиям.
- Backend:
  - `permissionsMiddleware` проверяет `can(user, key)` для опасных операций.
- Frontend:
  - прячет/disabled-кнопки для действий, которые запрещены,  
    но окончательное решение остаётся за backend.

---

## 6. Business Modules (по меню)

### 6.1. Дэшборд

- Модульная главная страница:
  - Сумма заказов (крупный primary-блок).
  - Активные и Завершённые заказы (по выбранному периоду).
  - График загруженности по дням недели.
  - Блок “Горящие заказы” (ближайшие дедлайны).
- В будущем — пресеты виджетов по ролям (дизайнер, производство, директор).

### 6.2. Заказы + Калькулятор

- Список заказов:
  - фильтры: строка поиска, даты, статус, “только мои”;
  - отображение в виде карточек (как на макете) и/или таблицы;
  - дополнительный режим канбан (колонки по статусам, drag’n’drop).

- Карточка заказа:
  - клиент/организация;
  - контакты (телефон с маской, почта);
  - дедлайн (дата + время, просрочки подсвечиваются красным);
  - ответственный (дизайнер/менеджер);
  - статусы (новый, в производстве, готов, выдан, отменён);
  - состав заказа (позиции калькулятора);
  - комментарии, вложения (позже);
  - история изменений (позже).

- Калькулятор:
  - неограниченное число позиций;
  - для каждой позиции:
    - выбор товара из базы `products`,
    - подтягивание категории, базовой цены, единицы измерения,
    - ввод тиража/количества,
    - поиск подходящего ценового уровня (`product_price_tiers`),
    - расчёт цены за единицу и суммы,
    - возможность ручной корректировки цены/скидки,
    - комментарий к позиции (например, особенности печати).
  - итоги по заказу:
    - сумма по позициям;
    - скидка на весь заказ (в процентах или рублях);
    - предоплата и остаток к оплате.

- Связка “Дизайнер → Производство”:
  - дизайнер нажимает “Отправить в производство”:
    - статус заказа меняется на `in_production`;
    - создаются уведомления для всех с `role = 'production'`;
    - заказ появляется в их списке/дэшборде.

### 6.3. Касса

- Список неоплаченных/частично оплаченных заказов:
  - фильтры по телефону, статусу, датам;
  - быстрый переход к карточке заказа.

- Окно оплаты:
  - выбор способа оплаты (нал, карта, безнал, предоплата/доплата);
  - сумма по умолчанию = остаток к оплате;
  - запись `Payment` и пересчёт `payment_status` заказа.

- Кассовые смены:
  - открытие/закрытие смен;
  - итоги смены (выручка, количество операций).

- Финансовые отчёты:
  - выручка за день/месяц/период;
  - экспорт в CSV/Excel.

### 6.4. Склад и Закупка

- Склад:
  - список материалов:
    - название, артикул, НДС, цена, ед.измерения, остаток, минимальный остаток;
  - история движений (приход/расход).

- Закупка:
  - автоматические заявки при падении остатка ниже минимума;
  - ручные заявки;
  - статусы: `new → in_progress → ordered → received`.

- Связка с заказами:
  - (позже) “рецепты” материалов на единицу продукции;
  - автоматическое списание материалов при проведении заказа.

### 6.5. Персонал

- Список сотрудников:
  - ФИО, роль, отдел, активность.

- (По мере развития):
  - график работы, отпуска, больничные;
  - присутствие (чек-ин/чек-аут, статус “на месте/отсутствует”);
  - статистика по выполненным заказам и просрочкам.

### 6.6. Аналитика

- Продажи:
  - выручка по дням/месяцам/годам;
  - сравнение периодов;
  - топ-клиенты, топ-продукты.

- Производство:
  - среднее время исполнения заказов;
  - количество просрочек;
  - загрузка по дням/сменам.

- Персонал:
  - производительность по людям и отделам.

- Отчёты:
  - генерация и выгрузка сводных отчётов (PDF/Excel).

### 6.7. Справочники и Настройки

- Справочники:
  - продукция, категории продукции;
  - ценовые уровни/скидки за тиражность;
  - материалы, единицы измерения;
  - статусы заказов;
  - способы оплаты;
  - отделы и должности.

- Настройки:
  - маска телефона `+7` + 10 цифр;
  - параметры скидок;
  - пресеты дэшборда по ролям;
  - бизнес-настройки (валюта, налоги);
  - параметры тем (какие токены за что отвечают).

### 6.8. Уведомления

- Уведомления:
  - новые заказы для производства;
  - изменения статусов заказа;
  - низкие остатки по складу;
  - системные предупреждения.

- UI:
  - иконка уведомлений (серый круг в хедере) с бейджем количества;
  - дропдаун со списком уведомлений;
  - возможность отметить как прочитанное и перейти к сущности (заказу/складу).

---

## 7. Key Data Structures (коротко)

- `users` — сотрудники (имя, роль, хеш кода доступа).
- `user_permissions` — индивидуальные запреты.
- `clients`, `organizations` — клиенты и юрлица.
- `products`, `product_categories` — справочник продукции.
- `product_price_tiers` — диапазоны тиражей и цены/скидки.
- `orders` — “шапка” заказа (клиент, суммы, статус, дедлайн).
- `order_items` — позиции заказа (товар, тираж, цены, скидки, итог).
- `materials`, `warehouse_items`, `warehouse_movements` — склад.
- `purchase_requests`, `purchase_orders` — закупка.
- `payments`, `cash_shifts` — финансы и касса.
- `staff`, `staff_*` — персонал (по необходимости).
- `notifications` — уведомления и их статус (прочитано/нет).

---

## 8. Основные потоки

1. **Авторизация по коду**  
   Пользователь вводит код → backend проверяет `access_code_hash` → выдаёт JWT и профиль → frontend сохраняет его в `authStore` → `MainLayout` показывает хэдер с именем, ролью, приветствием и кругами темы/уведомлений.

2. **Создание заказа с калькулятором**  
   Пользователь открывает “Заказы” → жмёт “+ Новый заказ” → в правом drawer:
   - выбирает существующего клиента или вводит нового;
   - задаёт дату и время дедлайна;
   - через “Продукция +” / “Постпечатка +” добавляет позиции;
   - калькулятор по тиражам и ценовым уровням считает стоимость;
   - при необходимости пользователь вручную корректирует скидки/суммы;
   - жмёт “Создать” → `orders` + `order_items` сохраняются → заказ появляется в списке.

3. **Отправка заказа в производство**  
   Дизайнер открывает заказ → проверяет состав → нажимает “Отправить в производство”:
   - статус меняется на `in_production`;
   - сервис уведомлений создаёт записи для всех `production`;
   - на их дэшборде и в списке заказов появляется новый заказ;  
   - круг уведомлений в хедере показывает непрочитанные события.

4. **Оплата и касса**  
   В “Кассе” кассир видит неоплаченные/частично оплаченные заказы:
   - выбирает заказ → открывает модалку оплаты;
   - выбирает метод (нал/карта/безнал) и сумму;
   - создаётся `payment`, статус заказа обновляется (`partial`/`paid`);
   - дэшборд и аналитика получают обновлённые суммы.

5. **Склад и закупка**  
   При проведении заказа (или вручную):
   - в `warehouse_movements` создаются записи расхода материалов;
   - если остаток < минимума — создаётся `purchase_request`;
   - в разделе “Склад” видны low-stock позиции, в “Закупка” — заявки.

6. **Аналитика и отчеты**  
   Директор открывает “Аналитика”:
   - видит графики выручки, топ-клиентов и топ-товаров;
   - отслеживает просрочки и загрузку производства;
   - при необходимости выгружает отчёт в Excel/PDF.
