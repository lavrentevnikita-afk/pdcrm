# Application Architecture

---

## 1. Core Architecture

- **Тип приложения:** внутренняя CRM/ERP-система для типографии  
  (заказы, касса, склад, персонал, аналитика).

- **Слои:**
  - **Backend (API-сервер)** — Node.js + Express + SQLite (через Knex).
  - **Frontend (SPA-клиент)** — Vue 3 + Vite + Vue Router + Pinia.

- **Обмен данными:** REST API по HTTP  
  `Frontend → /api/... → Backend → SQLite`.

- **Основные разделы (как в левом меню на макетах):**
  - **Основные**
    1. Дэшборд
    2. Заказы (список + создание через правый drawer + калькулятор)
    3. Касса
    4. Склад
  - **Управление**
    5. Персонал
    6. Аналитика
    7. Справочники
  - **Другое**
    8. Настройки
    9. Разрешения (права доступа)

---

## 2. Технологический стек

### Backend

- Node.js, Express
- SQLite3
- Knex (подключение, миграции, запросы)
- JWT (авторизация по кодам доступа)
- express-validator (валидация входящих данных)
- dotenv (конфиги)
- morgan (HTTP-логи)
- cors (CORS)
- npm-скрипты:
  - `dev` — запуск с nodemon
  - `start` — обычный запуск
  - `migrate`, `seed` — миграции/сиды

### Frontend

- Vue 3 (Composition API)
- Vite (dev-сервер + сборка)
- Vue Router (маршрутизация по разделам)
- Pinia (глобальное состояние)
- Axios (HTTP-запросы к API)
- Чистый CSS / Tailwind / легкая UI-библиотека — для быстрой стилизации
- Возможные допы:
  - библиотека графиков (Recharts / ECharts) для аналитики и графиков загрузки

---

## 3. Backend Architecture

### 3.1. Слои и структура

- **Routes (`src/routes/`)**
  - Группировка по доменам:
    - `/api/auth` — авторизация по коду
    - `/api/users` — пользователи (для админа/директора)
    - `/api/orders` — заказы, статусы, позиции
    - `/api/order-items` — управление позициями (если нужно отдельно)
    - `/api/products` — продукция, категории, ценовые уровни
    - `/api/clients` — клиенты и организации
    - `/api/cash` — касса, неоплаченные заказы
    - `/api/payments` — платежи
    - `/api/warehouse` — материалы, остатки, движения
    - `/api/purchase` — заявки на закупку
    - `/api/staff` — персонал, статусы (приход/уход)
    - `/api/analytics` — агрегированные данные для дэшборда/отчетов
    - `/api/settings` — справочники, общие настройки
    - `/api/permissions` — права доступа
    - `/api/notifications` — уведомления

- **Controllers (`src/controllers/`)**
  - Принимают запросы, валидируют входные данные, вызывают сервисы:
    - `auth.controller` — логин по коду, обновление токена.
    - `dashboard.controller` — сводка для дэшборда (сумма заказов, активные, горячие, график).
    - `orders.controller` — CRUD заказов, изменение статусов, работа с калькулятором.
    - `products.controller` — выдача списка продукции, категорий, ценовых уровней.
    - `cash.controller` — выборка неоплаченных заказов, операции кассы.
    - `warehouse.controller` — список материалов, движения, low-stock.
    - `staff.controller` — данные по сотрудникам.
    - `analytics.controller` — выдача аналитики.
    - `settings.controller` — справочники/общие настройки.
    - `permissions.controller` — управление индивидуальными правами пользователей.
    - `notifications.controller` — получение/прочтение уведомлений.

- **Services (`src/services/`)**
  - Содержат бизнес-логику, не зависящую от HTTP:
    - `orders.service`
      - создание/редактирование заказов;
      - рассчёт позиций (тираж, ценовые уровни, скидки);
      - пересчёт итогов по заказу;
      - статусные переходы (`new → in_production → ready → done → canceled`);
      - логика “Отправить в производство” (уведомления, события).
    - `products.service`
      - работа со справочником продукции;
      - поиск товаров, загрузка ценовых уровней.
    - `pricing.service`
      - расчёт стоимости по тиражу и скидкам;
      - общая скидка на заказ.
    - `warehouse.service`
      - списание/приход материалов;
      - проверка минимальных остатков;
      - генерация заявок на закупку.
    - `purchase.service`
      - управление заявками;
      - статусы `new / in_progress / ordered / received`.
    - `finance.service`
      - регистрация платежей;
      - вычисление статуса оплаты заказа;
      - расчёт сумм для кассы/отчетов.
    - `analytics.service`
      - агрегированные данные: выручка, топ-товары/клиенты, загрузка.
    - `staff.service`
      - список сотрудников;
      - (опционально) учёт рабочего времени.
    - `permissions.service`
      - проверка индивидуальных прав (`can(user, 'orders.delete')` и т.п.).
    - `notifications.service`
      - создание уведомлений (новый заказ, изменение статуса, низкие остатки).

- **Models (`src/models/`)**
  - Низкоуровневый доступ к БД через Knex:
    - `User`, `UserPermission`
    - `Client`, `Organization`
    - `Order`, `OrderItem`
    - `Product`, `ProductCategory`, `ProductPriceTier`
    - `Material`, `WarehouseItem`, `WarehouseMovement`
    - `PurchaseRequest`, `PurchaseOrder`, `PurchaseOrderItem`
    - `Payment`, `CashShift`
    - `Notification`
    - (опционально) `Staff`, `StaffSchedule`, `StaffAttendance`  
  - Модели не знают о HTTP — только CRUD и простые выборки.

- **DB-слой (`src/db/`)**
  - `knexfile.js` — конфиг подключения SQLite.
  - `connection.js` — инициализация Knex.
  - `migrations/` — создание/изменение таблиц.
  - `seeds/` — стартовые данные:
    - 11 пользователей с ролями и хешами кодов доступа;
    - базовые статусы заказов;
    - примерные товары, категории, материалы;
    - тестовые заказы для скринов/демо.

- **Инфраструктура (`src/config/`, `src/middleware/`, `src/utils/`)**
  - `config/`:
    - чтение `.env` (порт, DB_PATH, JWT_SECRET, CORS_ORIGIN).
  - `middleware/`:
    - `authMiddleware` — проверка JWT, установка `req.user`.
    - `permissionsMiddleware` — проверка прав по ключам.
    - `errorHandler`, `notFound` — единый формат ошибок.
    - `requestLogger` — morgan-логирование.
    - CORS-настройки.
  - `utils/`:
    - расчёт скидок и итогов;
    - форматирование телефона/дат/денег;
    - генерация мотивационных фраз;
    - helper’ы для пагинации, сортировки и пр.

---

## 4. Frontend Architecture

### 4.1. Каркас приложения

- `main.js`
  - инициализация Vue, Router, Pinia;
  - подключение глобальных стилей и базовых компонентов.

- `App.vue`
  - оборачивает всё в `MainLayout`:
    - левое меню (как на макетах),
    - верхний хэдер,
    - `router-view` с содержимым разделов.

- `MainLayout.vue`
  - **Sidebar**:
    - логотип и подпись “Печатный двор — Внутренняя CRM-система”;
    - поиск по меню (фильтрация пунктов);
    - группы:
      - Основные: Дэшборд, Заказы, Касса, Склад;
      - Управление: Персонал, Аналитика, Справочники;
      - Другое: Настройки, Разрешения.
    - внизу: версия `PDCRM v0.1 phaseX` + кнопка “Выход”.
  - **Header**:
    - текст приветствия: “Доброе утро/день/вечер, {Имя}!”;
    - подзаголовок с названием текущего раздела;
    - мотивационная фраза;
    - аватар/кружки статуса;
    - надпись “{Имя} — {Роль}” (например, “Никита — Производство”);
    - иконка уведомлений (количество непрочитанных).

### 4.2. Маршрутизация (`src/router/`)

- Основные маршруты:
  - `/login` — авторизация по коду доступа.
  - `/dashboard` — главная панель (виджеты).
  - `/orders` — список заказов + правый drawer “Создание заказа”.
  - `/orders/:id` — подробная карточка/редактор заказа.
  - `/cash` — раздел “Касса”.
  - `/warehouse` — раздел “Склад”.
  - `/staff` — раздел “Персонал”.
  - `/analytics` — раздел “Аналитика”.
  - `/directories` — раздел “Справочники”.
  - `/settings` — общие настройки.
  - `/permissions` — права доступа.

- Guards:
  - перед каждым приватным маршрутом:
    - проверка наличия токена в `authStore`;
    - попытка загрузить профиль (если не загружен);
    - при ошибке — редирект на `/login`.

### 4.3. Pinia-хранилища (`src/store/`)

- `authStore`
  - токен, данные пользователя (`id`, `name`, `role`);
  - состояние авторизации, методы `login`, `logout`.

- `uiStore`
  - состояние dашборда (набор виджетов и их позиции);
  - состояния drawer’ов и модалок (“Создание заказа”, “Выбор продукции”).

- `ordersStore`
  - список заказов, фильтры (поиск, даты, статус, “только мои”);
  - активный заказ;
  - методы для CRUD и смены статуса.

- `productsStore`
  - справочник продукции:
    - товары, категории, ценовые уровни;
  - кеширование запросов для калькулятора заказов.

- `warehouseStore`
  - список материалов, остатки, low-stock;
  - заявки на закупку.

- `cashStore`
  - неоплаченные и частично оплаченные заказы;
  - операции кассы.

- `staffStore`
  - список сотрудников, роль, отдел, статус.

- `analyticsStore`
  - данные для графиков и таблиц в разделе “Аналитика” и на дэшборде.

- `notificationsStore`
  - список уведомлений, счетчик непрочитанных.

### 4.4. API-слой (`src/api/`)

Каждый модуль — лёгкая обёртка над Axios:

- `auth.api` — логин/логаут, проверка токена.
- `dashboard.api` — суммарные данные (сумма заказов, активные/завершенные, горящие, график).
- `orders.api` — CRUD заказов, статусы, калькулятор (позиции).
- `products.api` — справочник продукции и ценовые уровни.
- `clients.api` — клиенты/организации.
- `cash.api` — неоплаченные заказы, операции кассы.
- `payments.api` — проведение оплат.
- `warehouse.api` — материалы, остатки, движения.
- `purchase.api` — заявки на закупку.
- `staff.api` — сотрудники и их статусы.
- `analytics.api` — данные для аналитики и дэшборда.
- `settings.api` — системные настройки.
- `permissions.api` — права пользователей.
- `notifications.api` — загрузка/прочтение уведомлений.

### 4.5. Компоненты

- **Общие UI-компоненты:**
  - `AppHeader`, `AppSidebar`, `AppCard`, `AppButton`.
  - `AppTable` — универсальная таблица для списков.
  - `AppModal`, `AppDrawer` — модальные окна и правый drawer.
  - `AppToast` — компонент уведомлений (успех/ошибка/инфо).
  - `FormField`, `TextInput`, `SelectInput`, `DatePicker`, `TimePicker`.
  - `ConfirmDialog` — подтверждение опасных действий.

- **Дэшборд:**
  - `DashboardTotalCard` — “Сумма заказов”.
  - `DashboardStatsCard` — “Активные / Завершенные”.
  - `DashboardWorkloadChart` — график загруженности.
  - `DashboardHotOrders` — список “Горящие заказы”.

- **Заказы:**
  - `OrdersList` — список карточек заказов с фильтрами (как на макете).
  - `OrderCard` — карточка заказа (статусы, клиент, состав, сумма, дата).
  - `OrderSidebarSummary` — блок справа “Активные / Готовые / Завершенные”.
  - `OrderCreateDrawer` — правый drawer “Создание заказа”.
  - `OrderCalculator` — интерфейс калькулятора.
  - `OrderItemsTable` — список позиций заказа.

- **Касса:**
  - `CashFilterBar` — фильтры (телефон, дата, статус).
  - `CashOrdersTable` — таблица заказов для оплаты.
  - `PaymentModal` — окно проведения оплаты.

- **Склад:**
  - `WarehouseTable` — список материалов с остатками.
  - `MaterialFormModal` — добавление/редактирование позиции.
  - `LowStockBadge` — индикатор низкого остатка.

- **Персонал:**
  - `StaffTable` — список сотрудников.
  - `StaffCard` — карточка сотрудника.

- **Аналитика:**
  - `RevenueChart`, `TopProductsTable`, `TopClientsTable`.

- **Справочники и права:**
  - `DirectoryEditor` — универсальный редактор списков.
  - `UserPermissionsTable` — таблица галочек по пользователю/правам.

---

## 5. Authentication & Permissions

### 5.1. Пользователи и коды доступа

- Сотрудники (как минимум 11 человек):
  - **Дизайнеры:** Александр, Анастасия, Валентина, Юлия, Ольга (`role: 'designer'`).
  - **Производство:** Никита, Виктор, Павел, Екатерина (`role: 'production'`).
  - **Директор:** Евгений (`role: 'director'`).
  - **Администратор:** Андрей (`role: 'admin'`).

- Авторизация:
  - экран логина — одно поле “Код доступа”;
  - backend:
    - ищет пользователя по хэшу кода (`access_code_hash` в `users`);
    - при успехе — выдаёт JWT + профиль пользователя;
  - админ/директор могут задавать/менять коды в разделе “Справочники / Пользователи”.

- После логина:
  - в хэдере отображаются:
    - приветствие по времени суток;
    - имя и роль;  
    - мотивационная фраза;
    - индикатор уведомлений.

### 5.2. Права и ограничения

- Базовая идея — **по умолчанию можно всё**, пока директор/админ явно не запретили.
- Таблица `user_permissions` хранит **индивидуальные запреты**:
  - `user_id`, `permission_key`, `allow` (обычно `false` для запрета).
- Примеры ключей:
  - `orders.delete`, `orders.cancel`, `orders.update_paid`;
  - `cash.register_payment`, `finance.export`;
  - `warehouse.update_stock`, `warehouse.delete_material`;
  - `settings.edit_users`, `settings.edit_permissions`.
- Backend:
  - middleware `permissionsMiddleware` проверяет наличие/отсутствие запрета.
- Frontend:
  - скрывает/отключает кнопки, если нет соответствующего права,  
    но окончательное решение всегда за backend.

---

## 6. Business Modules

### 6.1. Дэшборд

- Главная, модульная, как на макете:
  - большая карточка **“Сумма заказов”**;
  - карточки **“Активные / Завершённые”** с выбором периода;
  - график **“Загруженность”** по дням недели;
  - блок **“Горящие заказы”** — список ближайших по дедлайну.
- Данные собираются из заказов и платежей.
- В дальнейшем:
  - пресеты виджетов для разных ролей (дизайнер, производство, директор).

### 6.2. Заказы + Калькулятор

- Список заказов:
  - фильтры по строке поиска, датам, статусу, “только мои”;
  - карточки заказов с:
    - менеджером (дизайнером),
    - статусами (“В производстве”, “Горящий”),
    - клиентом,
    - составом (текст),
    - суммой и дедлайном.
- Боковая панель:
  - счётчики “Активные / Готовые / Завершённые”;
  - список последних завершённых.

- Создание заказа (drawer справа):
  - выбор существующего клиента или создание нового;
  - ввод контактов (с маской телефона);
  - дата и время дедлайна;
  - блоки:
    - “Продукция” — добавление позиций через калькулятор;
    - “Постпечатка” — доп. работы;
  - поле “Чек” (комментарий);
  - итоговая сумма, скидка, кнопки “Создать / Отмена”.

- Калькулятор:
  - выбор товара из справочника;
  - учёт тиража и ценовых уровней (`product_price_tiers`);
  - автоматические скидки за тираж;
  - ручная скидка по позиции и на весь заказ;
  - итог по каждой позиции и по заказу.

- Переход в производство:
  - кнопка “Отправить в производство”:
    - смена статуса;
    - создание уведомлений для роли `production`;
    - отображение заказа в их списке/дашборде.

### 6.3. Касса

- Управление оплатами:
  - список неоплаченных/частично оплаченных заказов;
  - панель фильтров (телефон, дата, статус оплаты и т.д.);
  - кнопка “Оплатить” для каждого заказа:
    - выбор способа оплаты (нал, карта, безнал);
    - сумма по умолчанию = остаток к оплате;
    - запись `Payment` и обновление статуса заказа.
- Внизу — агрегированная информация:
  - выручка за день/период;
  - (позже) суммарные показатели по смене.

### 6.4. Склад

- Справочник материалов и текущих остатков:
  - таблица с колонками: Название, Артикул, НДС, Цена, Ед., Остаток.
  - подсветка строк с остатком ниже минимального.
  - кнопка “Добавить позицию” — модалка с формой.
- Движения:
  - запись приходов/расходов (`warehouse_movements`).
- В будущем:
  - связка с заказами (авто-списание по рецептам продукции);
  - авто-создание заявок на закупку при низком остатке.

### 6.5. Персонал

- Список сотрудников:
  - ФИО, роль, отдел, статус (активен/уволен).
- Страница/модалка сотрудника:
  - контакты, роль, права.
- (дальше можно добавить учёт смен, отпусков, статистику по выполненным заказам).

### 6.6. Аналитика

- Общий раздел с графиками/таблицами:
  - выручка по дням/месяцам/годам;
  - топ-клиенты и топ-товары;
  - (позже) производительность по сотрудникам/отделам.
- Используется и на дэшборде, и в отдельном разделе.

### 6.7. Справочники и Настройки

- Справочники:
  - товары, категории, ценовые уровни;
  - материалы;
  - статусы заказов;
  - методы оплаты;
  - отделы и должности.
- Настройки:
  - маска телефона (`+7` + 10 цифр);
  - таблицы скидок за тиражность;
  - пресеты дэшборда;
  - общие параметры (валюта, НДС и т.п.).

### 6.8. Разрешения и Уведомления

- Раздел **“Разрешения”**:
  - таблица пользователей и чекбоксы по ключевым действиям;
  - директор/админ настраивают запреты.
- Уведомления:
  - новые заказы в производстве;
  - изменения статусов;
  - низкие остатки;
  - важные события (ошибки интеграций и т.д.).
  - отображение через иконку колокольчика в хэдере + дропдаун.

---

## 7. Key Data Structures (кратко)

- `users`: сотрудники, роли, коды доступа.
- `user_permissions`: индивидуальные запреты по ключам.
- `clients`, `organizations`: клиенты и юрлица.
- `products`, `product_categories`, `product_price_tiers`: продукция и ценообразование.
- `orders`: шапка заказа.
- `order_items`: позиции заказа, цены и скидки.
- `materials`, `warehouse_items`, `warehouse_movements`: склад, остатки, движения.
- `purchase_requests`, `purchase_orders`, `purchase_order_items`: закупка.
- `payments`, `cash_shifts`: касса и платежи.
- `notifications`: уведомления.
- (опционально) `staff_*`: расширенные данные по персоналу.

---

## 8. Основные потоки

1. **Авторизация по коду**  
   Пользователь вводит код → backend проверяет → выдаёт JWT и профиль → frontend сохраняет данные в `authStore` → показывает дэшборд с приветствием “Доброе утро, {Имя}!”.

2. **Создание заказа с калькулятором**  
   Пользователь открывает “Заказы” → нажимает “+ Новый заказ” → в правом drawer:
   - выбирает клиента или создаёт нового;
   - задаёт дату/время;
   - через “Продукция +” и “Постпечатка +” добавляет позиции (товар + тираж);
   - калькулятор считает суммы и скидки;
   - пользователь при необходимости вручную корректирует суммы;
   - нажимает “Создать” → заказ сохраняется (статус `new` или `draft`).

3. **Отправка заказа в производство**  
   Дизайнер открывает заказ → проверяет/дополняет → жмёт “Отправить в производство”:
   - статус меняется на `in_production`;
   - создаются уведомления для сотрудников производства;
   - заказ появляется в их списке и на дэшборде.

4. **Оплата и касса**  
   В разделе “Касса”:
   - видны неоплаченные/частично оплаченные заказы;
   - кассир выбирает заказ → жмёт “Оплатить” → выбирает способ оплаты → подтверждает;
   - создаётся `Payment`, статус заказа обновляется до `paid` / `partial`;
   - дэшборд и аналитика получают обновлённые суммы.

5. **Склад и закупка**  
   При выполнении/проведении заказа:
   - материалы списываются со склада (в будущем — по рецептам) через `warehouse_movements`;
   - если остаток < минимума → создаётся `purchase_request`;
   - в раздел
