# Print CRM Project Task Log

## Core Functionality (Planned)

Все начинается с нуля. Ни одна фича ещё не реализована, всё ниже — **план**.

---

### 1. Basic application structure

* **Description:**  
  Каркас приложения:  
  - backend на **Node.js + Express + SQLite (Knex)**;  
  - frontend на **Vue 3 + Vite**;  
  - единый лейаут (левое меню, хэдер, контент);  
  - базовые маршруты (Дэшборд, Заказы, Касса, Склад, Персонал, Аналитика, Справочники, Настройки, Разрешения).
* **Status:** Done.

---

### 2. Authorization by access codes

* **Description:**  
  Авторизация только по коду доступа:
  - таблица `users` с ролями и хешами кодов;
  - 11 заранее заведённых сотрудников;
  - экран входа с одним полем “Код доступа”;
  - backend: проверка кода и выдача JWT + профиля.
* **Status:** Done.

---

### 3. Header: greeting, theme, notifications

* **Description:**  
  Хэдер с приветствием, именем, ролью, мотивацией и серыми кругами:
  - круги: переключатель тёмной темы, уведомления, резерв под статус;
  - имя и роль текущего пользователя;
  - приветствие по времени суток;
  - мотивационная фраза.
* **Status:** Done.

---

### 4. Dashboard

* **Description:**  
  Дэшборд с крупными карточками (“Сумма заказов”, “Активные”, “Завершённые”), графиком “Загруженность” и блоком “Горящие заказы”.
* **Status:** Done.

---

### 5. Orders + Calculator

* **Description:**  
  Модуль заказов: список карточек, фильтры, правый drawer “Создание заказа”, калькулятор с продукцией/постпечаткой, кнопка “Отправить в производство”.
* **Status:** Done.

---

### 6. Finance / Cashbox

* **Description:**  
  Касса: неоплаченные/частично оплаченные заказы, проведение оплат, отчёт по смене.
* **Status:** Done.

---

### 7. Warehouse & Purchase

* **Description:**  
  Склад (остатки материалов, движения) + закладка закупок (заявки при низком остатке).
* **Status:** Done.

---

### 8. Staff / Analytics / Permissions / UX

* **Description:**  
  Персонал, аналитика, права доступа, система уведомлений и финальная полировка UI/UX.
* **Status:** Done.

---

## Project Tasks (Phases)

Задачи разбиты максимально мелко, чтобы удобно было ставить галочки.

---

### Phase 1: Project Setup & UI Skeleton

**Цель:** настроить окружение, структуру проекта и базовый UI-каркас, чтобы уже было приятно смотреть, даже без данных.

- #### 1.1. Репозиторий и структура

  - [x] Создать репозиторий на GitHub.
  - [x] Добавить `.gitignore` для Node/Vue/SQLite.
  - [ ] Создать корневую структуру:
    - [x] `backend/`
    - [x] `frontend/`
    - [x] `docs/` (архитектура, таски, запуск).

- #### 1.2. Backend: базовый скелет

  - [x] Инициализировать `backend` (`npm init`).
  - [ ] Установить пакеты:
    - [x] `express`, `cors`, `morgan`, `dotenv`;
    - [x] `sqlite3`, `knex`;
    - [x] `jsonwebtoken`, `bcrypt` (или `bcryptjs`);
    - [x] `express-validator`;
    - [x] `nodemon` (dev).
  - [x] Создать `src/server.js` с:
    - [ ] загрузкой `.env`;
    - [ ] подключением middleware (`cors`, `json`, `morgan`);
    - [x] заглушкой маршрута `/api/health`.
  - [x] Настроить `knexfile.js` и подключение к SQLite.
  - [x] Добавить npm-скрипты: `dev`, `start`, `migrate`, `seed`.

- #### 1.3. Frontend: базовый скелет

  - [x] Создать `frontend` через `npm create vite@latest` (Vue).
  - [ ] Установить:
    - [x] `vue-router`,
    - [x] `pinia`,
    - [x] `axios`.
  - [x] Подключить глобальные стили (`main.css` или Tailwind).
  - [ ] Настроить базовый `router`:
    - [x] маршруты `/login`, `/dashboard`, `/orders` и т.д. (заглушки).
  - [x] Добавить пустые страницы-компоненты:
    - [ ] `DashboardView`, `OrdersView`, `CashView`, `WarehouseView`, `StaffView`, `AnalyticsView`, `DirectoriesView`, `SettingsView`, `PermissionsView`.

- #### 1.4. Цветовая палитра и тема

  - [x] Завести CSS-переменные для палитры:
    - [ ] серые (4 уровня),
    - [ ] светлый голубой,
    - [ ] яркий голубой,
    - [ ] насыщенный синий,
    - [ ] зелёный,
    - [ ] кораллово-красный.
  - [x] Описать токены:
    - [ ] `--color-bg`, `--color-bg-alt`,
    - [ ] `--color-primary`, `--color-primary-soft`,
    - [ ] `--color-success`, `--color-error`,
    - [ ] `--color-border`, `--color-text`, `--color-text-muted`.
  - [x] Настроить 2 набора токенов: `light` и `dark` тема (через классы `theme-light`/`theme-dark` на `<body>`).

- #### 1.5. Глобальный лейаут (UI-каркас)

  - [x] Создать компонент `MainLayout`:
    - [ ] левый сайдбар;
    - [ ] верхний хэдер;
    - [ ] область контента.
  - [x] Внедрить `MainLayout` в `App.vue` (кроме `/login`).
  - [x] Сверстать **левое меню**:
    - [x] логотип/название (“Печатный двор — внутренняя CRM система”);
    - [x] группы меню: Основные / Управление / Другое;
    - [x] пункты: Дэшборд, Заказы, Касса, Склад, Персонал, Аналитика, Справочники, Настройки, Разрешения;
    - [x] поиск по меню (пока без логики или простая фильтрация).
  - [x] Добавить внизу меню:
    - [x] версию приложения (`PDCRM v0.1 phase1`);
    - [x] кнопку “Выход” (заглушка).

---

### Phase 2: Auth, Header & Theme/Notifications

**Цель:** авторизация по кодам доступа, хэдер с приветствием, темой и уведомлениями.

- #### 2.1. Миграции и сиды пользователей

  - [ ] Миграция `users`:
    - [ ] `id`, `name`, `role`, `access_code_hash`, `is_active`, timestamps.
  - [ ] Сидинг 11 пользователей:
    - [ ] 5 дизайнеров (Alexander, …);
    - [ ] 4 производства;
    - [ ] директор;
    - [ ] админ.
  - [ ] Скрипт для генерации хеша кода доступа.

- #### 2.2. Backend: авторизация

  - [ ] Endpoint `POST /api/auth/login`:
    - [ ] принимает `{ code }`;
    - [ ] ищет пользователя по `access_code_hash`;
    - [ ] при успехе — возвращает JWT + профиль.
  - [ ] Middleware `auth`:
    - [ ] проверяет JWT;
    - [ ] кладёт `req.user`.
  - [ ] Endpoint `GET /api/auth/me`:
    - [ ] возвращает профиль текущего пользователя.

- #### 2.3. Frontend: auth flow

  - [ ] Pinia `authStore`:
    - [ ] хранит токен, профиль, `isAuthenticated`;
    - [ ] методы `login`, `logout`, `fetchMe`.
  - [ ] Страница `/login`:
    - [ ] одно поле “Код доступа”;
    - [ ] кнопка “Войти”;
    - [ ] обработка ошибок (тост/текст под полем).
  - [ ] Router guards:
    - [ ] приватные маршруты → редирект на `/login`, если нет токена;
    - [ ] если есть — загрузка профиля.

- #### 2.4. Header: приветствие, имя, серые круги

  - [ ] Компонент `AppHeader`:
    - [ ] текст “Доброе утро/день/вечер, {Имя}!”;
    - [ ] подзаголовок с названием текущего раздела (из router meta);
    - [ ] отображение роли (бейдж “Производство”, “Дизайн”, “Директор”, “Админ”).
  - [ ] Реализовать мотивационные фразы:
    - [ ] массив строк с фразами;
    - [ ] случайный выбор при загрузке/обновлении страницы.
  - [ ] Серые круги справа:
    - [ ] 1-й — переключатель **светлая/тёмная тема**:
      - [ ] по клику меняет класс темы на корне;
      - [ ] запоминает выбор в `localStorage`.
    - [ ] 2-й — **уведомления**:
      - [ ] пока без реальных данных, просто открывает пустой дропдаун “Нет уведомлений”;
      - [ ] изменение цвета/маленький бейдж при наличии непрочитанных (подключим позже).
    - [ ] 3-й — резерв под будущее (например, быстрые настройки или статус системы).

---

### Phase 3: Dashboard

**Цель:** сделать живой дэшборд как на макете.

- #### 3.1. Backend: данные для дэшборда

  - [x] Миграция `orders` (минимальный набор полей: сумма, статус, дедлайн, флаг горящего).
  - [x] Endpoint `GET /api/dashboard/summary`:
    - [x] общая сумма заказов за период;
    - [x] количество активных/завершенных;
    - [x] список “горящих” (ближайшие дедлайны);
    - [x] данные для графика загрузки (по дням недели).
  - [x] Написать простые seed-данные (несколько заказов разных статусов).

- #### 3.2. Frontend: карточки и график

  - [ ] Компонент `DashboardView`:
    - [ ] оформить сетку виджетов (как на макете).
  - [ ] Компонент `DashboardTotalCard`:
    - [x] большая синяя карточка “Сумма заказов”;
    - [x] отображение суммы и процента изменения.
  - [x] Компоненты `DashboardStatCard`:
    - [x] “Активные заказы”;
    - [x] “Завершенные заказы”;
    - [x] селект/кнопка выбора периода (например, текущий месяц).
  - [x] Компонент `DashboardWorkloadChart`:
    - [x] линейный график “Загруженность” (Mon–Sun);
    - [x] пока можно взять статичные данные с последующей заменой на API.
  - [x] Компонент `DashboardHotOrders`:
    - [x] список карточек “горящих заказов”;
    - [x] название, номер, дата дедлайна красным;
    - [ ] клик → переход к заказу / открытие модалки (позже).

---

### Phase 4: Orders — список, фильтры, создание заказа (без сложного калькулятора)

**Цель:** базовый модуль заказов, визуально как на макете, но пока с простой ценой.

- #### 4.1. Backend: базовые структуры заказов

  - [ ] Расширить `orders`:
    - [ ] `client_name`, `client_phone`, `manager_id`, `status`, `deadline_at`, `sum_total`, `is_hot`.
  - [ ] Endpoint’ы:
    - [ ] `GET /api/orders` — список с фильтрами (поиск, статус, даты, “мои”).
    - [ ] `GET /api/orders/:id` — детали.
    - [ ] `POST /api/orders` — создание.
    - [ ] `PUT /api/orders/:id` — редактирование.
    - [ ] `PUT /api/orders/:id/status` — смена статуса.

- #### 4.2. Frontend: список заказов

  - [ ] Структура `OrdersView`:
    - [ ] зона фильтров сверху;
    - [ ] зона карточек заказов;
    - [ ] правая сводка “Активные / Готовые / Завершённые”.
  - [ ] Фильтры:
    - [ ] строка поиска;
    - [ ] дата от/до;
    - [ ] чекбокс “все заказы / только мои”.
  - [ ] Компонент `OrderCard`:
    - [ ] имя дизайнера/ответственного;
    - [ ] бейджи статусов (“В производстве”, “Горящий”);
    - [ ] информация по клиенту;
    - [ ] состав (пока текстом);
    - [ ] сумма и дедлайн (красным, если скоро/просрочка);
    - [ ] выпадающий список “Статус”.
  - [ ] Правая сводка:
    - [ ] количество активных, готовых, завершённых;
    - [ ] блок “Завершенные” с последним заказом (как на макете).

- #### 4.3. Drawer “Создание заказа” (минимальная версия)

  - [ ] Компонент `OrderCreateDrawer`:
    - [ ] открывается по кнопке “+ Новый заказ”.
  - [ ] Формы:
    - [ ] выбор существующего клиента / переключатель “Новый клиент”;
    - [ ] поля нового клиента: имя, фамилия, телефон (маска `+7`), почта;
    - [ ] выбор даты и времени;
    - [ ] блоки “Продукция” и “Постпечатка” — пока просто текстовые поля или количество записей;
    - [ ] поле “Чек” (комментарий);
    - [ ] отображение итоговой суммы (пока руками).
  - [ ] Кнопки:
    - [ ] “Отмена” и “Создать”;
    - [ ] валидация обязательных полей (имя клиента, телефон, дедлайн).

---

### Phase 5: Calculator & Product Directory

**Цель:** превратить “Продукцию” и “Постпечатку” в реальный калькулятор.

- #### 5.1. Backend: справочник продукции и цен

  - [x] Миграция `product_categories`.
  - [x] Миграция `products`:
    - [x] `name`, `category_id`, `base_price`, `unit`, `comment`.
  - [x] Миграция `product_price_tiers`:
    - [x] `product_id`, `min_qty`, `max_qty`, `price_per_unit` или `discount_percent`.
  - [x] Сиды:
    - [x] базовые категории (полиграфия, текстиль, керамика и т.д.);
    - [x] несколько товаров по категориям с ценами и тиражами.
  - [x] Endpoint’ы:
    - [x] `GET /api/products` (с фильтрами по категории/поиску);
    - [x] `GET /api/products/:id/price-tiers`;
    - [x] `POST/PUT/DELETE` для админки (справочники).

- #### 5.2. Backend: позиции заказа

  - [x] Миграция `order_items`:
    - [x] `order_id`, `product_id`, `product_name`,
    - [x] `quantity`, `unit`,
    - [x] `base_price`, `unit_price`,  
      `discount_percent`, `discount_value`,  
      `total_price`, `comment`.
  - [x] В `orders.service`:
    - [x] функция расчёта позиции по тиражу и ценовым уровням;
    - [x] функция пересчёта итогов заказа (сумма, скидка, остаток).

- #### 5.3. Frontend: калькулятор в drawer

  - [x] Компонент `OrderItemRow`:
    - [x] селект товара (поиск по названию + выбор категории);
    - [x] поле тиража/количества;
    - [x] отображение цены за единицу и итога по строке;
    - [x] поля ручной скидки (% или сумма);
    - [x] кнопка удаления строки.
  - [x] В `OrderCreateDrawer`:
    - [x] кнопка “Продукция +” → добавляет строку `OrderItemRow`;
    - [x] отдельный блок для постпечатки (можно отдельный справочник/категорию);
    - [x] подсчёт:
      - [x] сумма по всем позициям;
      - [x] поле скидки на весь заказ;
      - [x] итог к оплате.
  - [x] Сохранение:
    - [x] отправка `order` + `order_items` на backend;
    - [x] обновление списка заказов.

---

### Phase 6: Finance / Cashbox

**Цель:** сделать работающую кассу.

- #### 6.1. Backend: финансы

  - [x] Миграция `payments`:
    - [x] `order_id`, `amount`, `method`, `paid_at`, `created_by`.
  - [x] Миграция `cash_shifts`:
    - [x] `opened_at`, `closed_at`, `opened_by`, `closed_by`, `total_amount`.
  - [x] Добавить в `orders`:
    - [x] поле `paid_amount`, `payment_status`.
  - [x] Endpoint’ы:
    - [x] `GET /api/cash/orders` — неоплаченные/частично оплаченные;
    - [x] `POST /api/payments` — провести оплату;
    - [x] `GET /api/cash/shift/current` + `POST /api/cash/shift/open|close`.

- #### 6.2. Frontend: экран “Касса”

  - [ ] `CashView`:
    - [ ] панель фильтров (телефон, дата исполнения, статус оплаты);
    - [ ] таблица заказов (ID, клиент, сумма, статус, остаток к оплате).
  - [ ] Модалка “Оплата заказа”:
    - [ ] поля: сумма к оплате (по умолчанию остаток), способ оплаты;
    - [ ] кнопка “Провести оплату”;
    - [ ] отображение ошибок/успеха (тосты).
  - [ ] Блок “Итоги”:
    - [ ] сумма оплат за текущую смену/день.

---

### Phase 7: Warehouse, Purchase, Staff, Analytics, Permissions, Notifications

**Цель:** закрыть оставшиеся модули и связки.

- #### 7.1. Склад и закупка

  - [ ] Миграции `materials`, `warehouse_items`, `warehouse_movements`.
  - [ ] Endpoint’ы склада:
    - [ ] `GET /api/warehouse/items`;
    - [ ] `POST /api/warehouse/items`;
    - [ ] `POST /api/warehouse/movements`.
  - [ ] Миграции и API для `purchase_requests`.
  - [ ] `WarehouseView`:
    - [ ] таблица остатков;
    - [ ] кнопка “Добавить позицию”;
    - [ ] подсветка низких остатков;
    - [ ] вкладка/панель “Закупка” с заявками.

- #### 7.2. Персонал

  - [ ] Миграции `staff`, (опционально `staff_schedule`, `staff_attendance`).
  - [ ] API:
    - [ ] `GET /api/staff`;
    - [ ] базовые CRUD-операции.
  - [ ] `StaffView`:
    - [ ] таблица сотрудников (имя, роль, отдел);
    - [ ] карточка сотрудника (контакт, роль, базовая статистика).

- #### 7.3. Аналитика

  - [ ] API `GET /api/analytics/revenue`, `.../top-products`, `.../top-clients`.
  - [ ] `AnalyticsView`:
    - [ ] график выручки по дням/месяцам;
    - [ ] таблицы топ-клиентов и топ-продуктов.

- #### 7.4. Права и уведомления

  - [ ] Миграция `user_permissions`.
  - [ ] API для прав:
    - [ ] `GET /api/permissions/users`;
    - [ ] `POST /api/permissions/:userId`.
  - [ ] `PermissionsView`:
    - [ ] таблица пользователей и чекбоксы действий.
  - [ ] Миграция `notifications`.
  - [ ] API уведомлений:
    - [ ] `GET /api/notifications`;
    - [ ] `POST /api/notifications/mark-read`.
  - [ ] Подключить иконку уведомлений в хедере к реальным данным.

---

### Phase 8: UI & UX Polishing + Testing

**Цель:** довести всё до состояния “приятно пользоваться каждый день”.

- #### 8.1. Дизайн-система

  - [ ] Финализировать палитру и токены для светлой/тёмной темы.
  - [ ] Описать sizes для шрифтов (H1, H2, body, caption).
  - [ ] Выстроить систему отступов и радиусов.

- #### 8.2. Унификация компонентов

  - [ ] Вынести общие компоненты:
    - [ ] `AppButton`, `AppInput`, `AppSelect`, `AppTable`, `AppCard`, `AppModal`, `AppDrawer`, `AppToast`.
  - [ ] Пройтись по всем экранам и заменить “разрозненный” UI на общие компоненты.

- #### 8.3. Состояния и валидация

  - [ ] Добавить лоадеры/скелетоны на основных экранах (дэшборд, заказы, касса).
  - [ ] Унифицировать отображение ошибок (тосты + подсветка полей).
  - [ ] Маска телефона `+7 (XXX) XXX-XX-XX` + валидация длины.
  - [ ] Подтверждения для опасных действий (удаление, отмена, возврат).

- #### 8.4. UX и доработки по ролям

  - [ ] Отдельные “виды” дэшборда по ролям (или хотя бы разные наборы виджетов).
  - [ ] Проверка ключевых сценариев:
    - [ ] дизайнер: создание/отправка заказа;
    - [ ] производство: просмотр очереди и смена статусов;
    - [ ] директор: просмотр аналитики/финансов.
  - [ ] Микро-анимации (открытие drawer’ов, hover’ы, drag’n’drop в канбане).

- #### 8.5. Testing

  - [ ] Базовые backend-тесты (авторизация, создание заказа, оплата).
  - [ ] Smoke-тесты фронта (ручные чек-листы).
  - [ ] Прогон полного цикла:
    - [ ] дизайнер создаёт заказ → отправляет в производство;
    - [ ] производство выполняет → директор/касса принимает оплату;
    - [ ] заказ попадает в аналитику.

---
